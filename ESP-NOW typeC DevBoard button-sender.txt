#include <WiFi.h>
#include <esp_now.h>

#define BUTTON_PIN 26
uint8_t wemosAddress[] = {0x3C,0x71,0xBF,0x70,0x6E,0x94};

typedef struct { char msg[64]; } packet_t;
packet_t outgoing;
int counter = 0;
bool lastPressed = false;

// New send callback signature
void onSent(const wifi_tx_info_t *tx_info, esp_now_send_status_t status){
  Serial.print("TYPEC send -> ");
  Serial.println(status == ESP_NOW_SEND_SUCCESS ? "OK" : "FAIL");
}

void setup(){
  Serial.begin(115200);
  WiFi.mode(WIFI_STA);
  pinMode(BUTTON_PIN, INPUT_PULLUP);

  if (esp_now_init() != ESP_OK) { Serial.println("ESP-NOW init failed"); return; }
  esp_now_register_send_cb(onSent);

  esp_now_peer_info_t peer = {};
  memcpy(peer.peer_addr, wemosAddress, 6);
  peer.channel = 0;
  peer.encrypt = false;
  esp_now_add_peer(&peer);
}

void loop(){
  bool pressed = !digitalRead(BUTTON_PIN); // active low
  if (pressed && !lastPressed) counter++;
  lastPressed = pressed;

  snprintf(outgoing.msg, sizeof(outgoing.msg), "TYPEC,%d", counter);
  esp_now_send(wemosAddress, (uint8_t*)&outgoing, sizeof(outgoing));
  delay(200); // faster updates after button actions
}
